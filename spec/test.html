<!DOCTYPE HTML>
<html>

  <head>
    <title>test</title>

    <script src="h-1.2.0-028b4eb.min.js"></script>

    <script src="jaabro.js"></script>
    <script src="../src/saintmarc.js"></script>
    <!--script src="helpers.js"></script-->

    <!--link
      rel="stylesheet"
      href="https://meyerweb.com/eric/tools/css/reset/reset.css"
      type="text/css" /-->
    <style>
      textarea {
        width: 100%;
        height: 14em;
      }
      pre {
        font-size: 77%;
        border: 1px solid black;
        height: fit-content;
        padding: 3px;
        white-space: pre-wrap;
        word-break: break-word;
      }

      #parse-tree {
        font-size: 84%;
        font-family: monospace;
      }
      .jaabro-children {
        padding-left: 1em;
      }
      .jaabro-tree {
        /*
        width: fit-content;
        */
        border-top: 1px solid lightgrey;
      }
      .jaabro-summary:hover { background-color: lightgreen; }
      .jaabro-failure > .jaabro-summary:hover { background-color: #ff8888; }
      .jaabro-success {
        border-left: 2px solid lightgreen;
      }
      .jaabro-failure {
        border-left: 2px solid red;
      }
      .jaabro-name {
        cursor: pointer;
      }
      .jaabro-children-count {
        cursor: pointer;
      }
      .jaabro-summary > span {
        padding-left: 0.35em;
      }
      /*.jaabro-summary > .jaabro-at { display: none; }*/
      .jaabro-summary > .jaabro-name:not(.jaabro-no-name) {
        font-weight: bold;
      }
      span.jaabro-match { float: right; }
      span.jaabro-string { background-color: lightgreen; }
      span.jaabro-post-string { background-color: lightgrey; }
      .jaabro-failed-children-count {
        padding-left: 0.35em;
      }
      .jaabro-parser {
        padding-left: 0.35em;
        opacity: 0.5;
      }
    </style>
  </head>

  <body>

    <h1>saintmarc</h1>

    <h2>in:</h2>
    <textarea id="in">
This is a &lt;a href="http://example.com/?a=b"&gt;link</a>.

This is another [link](http://example.org).
    </textarea>
<!--
Counting to five:

0. **one**.
0. ~~two~~
0. <strong>stronger</strong>

Click [here](http://example.com/).

**bold** and _italic_.
-->

    <h2>tree:</h2>
    <pre id="tree"></pre>

    <h2>out:</h2>
    <div id="out"></div>

    <h2>parse tree:</h2>
    <div id="parse-tree"></div>

    <script>

      var clog = console.log;

      //var removeAll = function(sel) {
      //  H.elts(sel)
      //    .forEach(function(e) { e.parentElement.removeChild(e); });
      //  return undefined;
      //};

      var toPre = function(depth, tree, out) {

        var s = JSON.stringify;

        try {

          var ind = ''; for (var i = 0; i < depth; i++) ind = ind + '  ';

          out = out + ind + tree[0];

          if (tree[0] === 'a') {
            out = out + ' href:' + s(tree[1][1]) + ' ' + s(tree[1][0]);
          }
          else if (Array.isArray(tree[1])) {
            tree[1]
              .forEach(function(c) {
                out = out + '\n'; out = toPre(depth + 1, c, out); });
          }
          else {
            out = out + ' ' + s(tree[1]);
          }
        } catch(e) {
          //console.error('toPre() intercepted', e);
        }
        return out;
      };

      var render = function() {

        var s = H.elt('#in').value.trim();

        // #tree
        //
        var t = SaintMarc.parse(s);
        if (t) H.elt('#tree').textContent = toPre(0, t, '');
        else H.create('#tree', 'em', {}, '(parsing failed)');

        // #out
        //
        var e = SaintMarc.toHtml(s);
        //clog(e);
        H.remove('#out > *');
        if (e) H.elt('#out').appendChild(e);
        else H.create('#out', 'em', {}, '(parsing failed)');

        // #parse-tree
        //
        var t = SaintMarc.parse(s, { debug: 3 });
        //clog(t);
        H.remove('#parse-tree > div');
        H.elt('#parse-tree').appendChild(t.toHtml());

        H.elts('.jaabro-extra')
          .forEach(function(e) { e.style.display = 'none'; });
        H.elts('.jaabro-failure')
          .forEach(function(e) { e.style.display = 'none'; });
        try {
          H.elt('#parse-tree > .jaabro-failure').style.display = null;
        } catch(e) {}

        H.on('.jaabro-name', 'click', function(ev) {
          var t = ev.target.closest('.jaabro-tree');
          var ex = t.querySelector('.jaabro-extra');
          ex.style.display = ex.style.display === 'none' ? null : 'none';
        });

        H.on('.jaabro-children-count', 'click', function(ev) {
          var t = ev.target
            .closest('.jaabro-tree');
          var fs = t
            .querySelectorAll(':scope > .jaabro-children > .jaabro-failure');
          var d = (fs[0] && fs[0].style.display === 'none') ? null : 'none';
          fs
            .forEach(function(f) { f.style.display = d; });
        });
      };

      H.on('#in', 'keyup', render);

      render();

    </script>

  </body>
</html>

