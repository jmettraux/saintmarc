<!DOCTYPE HTML>
<html>

  <head>
    <title>test</title>

    <script src="h-1.2.0-028b4eb.min.js"></script>

    <script src="jaabro.js"></script>
    <script src="../src/saintmarc.js"></script>
    <!--script src="helpers.js"></script-->

    <!--link
      rel="stylesheet"
      href="https://meyerweb.com/eric/tools/css/reset/reset.css"
      type="text/css" /-->
    <link rel="stylesheet" href="test.css" type="text/css" />
  </head>

  <body>

    <h1>saintmarc</h1>

    <h2>in:</h2>
    <textarea id="in">
1 &lt;7&gt; 4
1 &lt; 7 &gt; 4
    </textarea>
    <!--
    <textarea id="in">
_emphasis_
    </textarea>
    <textarea id="in">
&lt;a href="b"&gt;rotten &lt;em&gt;tomato&lt;/em&gt; chips&lt;/a&gt;
    </textarea>
    <textarea id="in">
&lt;dl&gt;
  &lt;dt&gt;Definition list&lt;/dt&gt;
  &lt;dd&gt;Is something people use sometimes.&lt;/dd&gt;
  &lt;dt&gt;Markdown in HTML&lt;/dt&gt;
  &lt;dd&gt;Does *not* work **very** well. Use HTML &lt;em&gt;tags&lt;/em&gt;.&lt;/dd&gt;
&lt;/dl&gt;
    </textarea>
    <textarea id="in">
* abc
* def
* ghi

1. nada
2. surf
3. corona
    </textarea>
    <textarea id="in">
This is a &lt;a href="http://example.com/?a=b"&gt;link</a>.

This is another [link](http://example.org).
abc<br>def<br/>ghi<br>jkl<br/>mno
    </textarea>
    -->
<!--
Counting to five:

0. **one**.
0. ~~two~~
0. <strong>stronger</strong>

Click [here](http://example.com/).

**bold** and _italic_.
-->

    <h2>tree:</h2>
    <pre id="tree"></pre>

    <h2>out:</h2>
    <div id="out"></div>

    <h2><span id="toggle-failure">parse</span> <span id="toggle-extra">tree</span>:</h2>
    <div id="parse-tree"></div>

    <script>

      var clog = console.log;

      var toPre = function(depth, tree, out) {

        //try {

        var ind = ''; for (var i = 0; i < depth; i++) ind = ind + '  ';
        out = out + (depth === 0 ? '' : '\n') + ind;

        if (typeof tree === 'string') {

          out = out + JSON.stringify(tree);
        }
        else {

          out = out + tree[0];

          for (var k in tree[1]) {
            out = out + ' ' + k + ': ' + JSON.stringify(tree[1][k]);
          }
          if (
            Object.keys(tree[1]).length < 1 &&
            tree[2].length === 1 &&
            (typeof tree[2][0]) === 'string'
          ) {
            out = out + ' ' + JSON.stringify(tree[2][0]);
          }
          else {
            tree[2].forEach(function(tt) {
              out = toPre(depth + 1, tt, out);
            });
          }
        }
        //} catch(e) { console.error('toPre() intercepted', e); }

        return out;
      };

      var render = function() {

        var s = H.elt('#in').value.trim();

        // #tree
        //
        var t = SaintMarc.parse(s);
        if (t) H.elt('#tree').textContent = toPre(0, t, '');
        else H.create(H.elt('#tree'), 'em', {}, '(parsing failed)');

        // #out
        //
        var e = SaintMarc.toHtml(s);
        //clog(e);
        H.remove('#out > *');
        if (e) H.elt('#out').appendChild(e);
        else H.create(H.elt('#out'), 'em', {}, '(parsing failed)');

        // #parse-tree
        //
        var t = SaintMarc.parse(s, { debug: 3 });
        //clog(t);
        H.remove('#parse-tree > div');
        H.elt('#parse-tree').appendChild(t.toHtml());

        H.elts('.jaabro-extra')
          .forEach(function(e) { e.style.display = 'none'; });
        H.elts('.jaabro-failure')
          .forEach(function(e) { e.style.display = 'none'; });
        try {
          H.elt('#parse-tree > .jaabro-failure').style.display = null;
        } catch(e) {}

        H.on('.jaabro-name', 'click', function(ev) {
          var t = ev.target.closest('.jaabro-tree');
          var ex = t.querySelector('.jaabro-extra');
          ex.style.display = ex.style.display === 'none' ? null : 'none';
        });

        H.on('.jaabro-children-count', 'click', function(ev) {
          var t = ev.target
            .closest('.jaabro-tree');
          var fs = t
            .querySelectorAll(':scope > .jaabro-children > .jaabro-failure');
          var d = (fs[0] && fs[0].style.display === 'none') ? null : 'none';
          fs
            .forEach(function(f) { f.style.display = d; });
        });

        function makeTog(k) {
          return function(ev) {
            var d =
              (H.elt('.jaabro-' + k).style.display === 'none') ?
              null :
              'none';
            H.forEach('.jaabro-' + k, function(e) { e.style.display = d; });
          };
        }
        H.on('#toggle-failure', 'click', makeTog('failure'));
        H.on('#toggle-extra', 'click', makeTog('extra'));
      };

      H.on('#in', 'keyup', render);

      render();

    </script>

  </body>
</html>

